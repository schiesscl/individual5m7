# Ejercicio Individual - MÃ³dulo 7: Django ORM y SQL con MySQL
## Hans Schiess

Proyecto Django que implementa 11 ejercicios prÃ¡cticos sobre el uso del ORM de Django, consultas SQL personalizadas, cursores y procedimientos almacenados con MySQL.

## ğŸ“‹ DescripciÃ³n del Proyecto

Este proyecto demuestra diferentes tÃ©cnicas para interactuar con una base de datos MySQL desde Django, incluyendo:

- Uso del ORM de Django para operaciones CRUD
- Filtros y consultas avanzadas
- Consultas SQL directas con `raw()`
- Manejo de cursores y conexiones manuales
- Procedimientos almacenados
- Anotaciones y campos calculados
- OptimizaciÃ³n de consultas con Ã­ndices

## ğŸ› ï¸ TecnologÃ­as Utilizadas

- **Python 3.12**
- **Django 5.2.7**
- **MySQL 8.0+**
- **mysqlclient** (conector MySQL para Python)
- **Bootstrap 5.3.2** (Frontend)

## ğŸ“ Estructura del Proyecto

```
individual5m7/
â”œâ”€â”€ manage.py
â”œâ”€â”€ individual5m7/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ settings.py          # ConfiguraciÃ³n con MySQL
â”‚   â”œâ”€â”€ urls.py              # URLs principales
â”‚   â”œâ”€â”€ wsgi.py
â”‚   â””â”€â”€ asgi.py
â””â”€â”€ productos/
    â”œâ”€â”€ models.py            # Modelo Producto
    â”œâ”€â”€ views.py             # Vistas para los 11 ejercicios
    â”œâ”€â”€ urls.py              # URLs de la app
    â”œâ”€â”€ admin.py             # ConfiguraciÃ³n del admin
    â”œâ”€â”€ migrations/
    â”‚   â””â”€â”€ 0001_initial.py
    â””â”€â”€ templates/
        â””â”€â”€ productos/
            â”œâ”€â”€ base.html
            â”œâ”€â”€ listar.html
            â”œâ”€â”€ filtrados.html
            â”œâ”€â”€ raw.html
            â”œâ”€â”€ raw_mapeo.html
            â”œâ”€â”€ sin_disponible.html
            â”œâ”€â”€ con_impuesto.html
            â”œâ”€â”€ raw_parametros.html
            â”œâ”€â”€ insertar_sql.html
            â”œâ”€â”€ cursor.html
            â””â”€â”€ procedimiento.html
```

## ğŸš€ InstalaciÃ³n y ConfiguraciÃ³n

### 1. Clonar el repositorio

```bash
git clone <url-del-repositorio>
cd "M7_AE5_ABP-Ejercicio individual"
```

### 2. Crear y activar entorno virtual

```powershell
# Windows PowerShell
python -m venv venv
.\venv\Scripts\Activate.ps1

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

### 3. Instalar dependencias

```bash
pip install django mysqlclient
```

### 4. Configurar MySQL

**Crear la base de datos:**

```sql
mysql -u root -p
```

```sql
CREATE DATABASE individual5m7_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**Crear el procedimiento almacenado:**

```sql
USE individual5m7_db;

DELIMITER //
CREATE PROCEDURE obtener_productos_por_precio(IN precio_minimo DECIMAL(5,2))
BEGIN
    SELECT * FROM productos_producto WHERE precio >= precio_minimo;
END //
DELIMITER ;
```

### 5. Configurar Django

El archivo [`individual5m7/settings.py`](individual5m7/individual5m7/settings.py) ya estÃ¡ configurado con:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'individual5m7_db',
        'USER': 'root',
        'PASSWORD': 'root',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}
```

**Nota:** Ajusta `USER` y `PASSWORD` segÃºn tu configuraciÃ³n de MySQL.

### 6. Aplicar migraciones

```bash
cd individual5m7
python manage.py makemigrations
python manage.py migrate
```

### 7. Crear superusuario

```bash
python manage.py createsuperuser
```

### 8. Cargar datos de prueba (opcional)

Puedes agregar productos desde el panel de administraciÃ³n o usar el shell de Django:

```bash
python manage.py shell
```

```python
from productos.models import Producto

Producto.objects.create(nombre="Laptop", precio=899.99, disponible=True)
Producto.objects.create(nombre="Mouse", precio=25.50, disponible=True)
Producto.objects.create(nombre="Teclado", precio=45.00, disponible=False)
Producto.objects.create(nombre="Monitor", precio=299.99, disponible=True)
Producto.objects.create(nombre="AudÃ­fonos", precio=79.99, disponible=True)
Producto.objects.create(nombre="Webcam", precio=59.99, disponible=False)
Producto.objects.create(nombre="Alfombrilla", precio=15.99, disponible=True)
exit()
```

### 9. Ejecutar el servidor

```bash
python manage.py runserver
```

Accede a: `http://127.0.0.1:8000/productos/`

## ğŸ“š Ejercicios Implementados

### Ejercicio 1: Recuperando Registros con Django ORM
**URL:** `/productos/`

Muestra todos los productos usando `Producto.objects.all()`

**Vista:** [`listar_productos`](individual5m7/productos/views.py)
**Template:** [`listar.html`](individual5m7/productos/templates/productos/listar.html)

---

### Ejercicio 2: Aplicando Filtros en RecuperaciÃ³n de Registros
**URL:** `/productos/filtrados/`

Implementa tres filtros diferentes:
- Productos con precio > $50: `filter(precio__gt=50)`
- Productos que empiezan con "A": `filter(nombre__startswith='A')`
- Productos disponibles: `filter(disponible=True)`

**Vista:** [`productos_filtrados`](individual5m7/productos/views.py)
**Template:** [`filtrados.html`](individual5m7/productos/templates/productos/filtrados.html)

---

### Ejercicio 3: Ejecutando Queries SQL desde Django
**URL:** `/productos/raw/`

Ejecuta una consulta SQL directa para obtener productos con precio < $50:

```python
Producto.objects.raw('SELECT * FROM productos_producto WHERE precio < 50')
```

**Vista:** [`productos_raw`](individual5m7/productos/views.py)
**Template:** [`raw.html`](individual5m7/productos/templates/productos/raw.html)

---

### Ejercicio 4: Mapeando Campos de Consultas al Modelo
**URL:** `/productos/raw-mapeo/`

Muestra cÃ³mo los campos del SQL se mapean a atributos del modelo:

```python
Producto.objects.raw(
    'SELECT id, nombre, precio, disponible FROM productos_producto WHERE precio BETWEEN 20 AND 80'
)
```

**Vista:** [`productos_raw_mapeo`](individual5m7/productos/views.py)
**Template:** [`raw_mapeo.html`](individual5m7/productos/templates/productos/raw_mapeo.html)

---

### Ejercicio 5: Realizando BÃºsquedas de Ãndice

El Ã­ndice estÃ¡ definido en el modelo [`Producto`](individual5m7/productos/models.py):

```python
class Meta:
    indexes = [
        models.Index(fields=['nombre'], name='idx_nombre'),
    ]
```

Para verificar Ã­ndices en MySQL:

```sql
SHOW INDEX FROM productos_producto;
```

**Beneficios:**
- âœ… Mejora la velocidad de bÃºsquedas por nombre
- âœ… Optimiza filtros y ordenamiento
- âœ… Reduce el tiempo de consultas en tablas grandes

---

### Ejercicio 6: ExclusiÃ³n de Campos del Modelo
**URL:** `/productos/sin-disponible/`

Usa `defer()` para excluir el campo `disponible` de la consulta inicial:

```python
Producto.objects.defer('disponible').all()
```

**Vista:** [`productos_sin_disponible`](individual5m7/productos/views.py)
**Template:** [`sin_disponible.html`](individual5m7/productos/templates/productos/sin_disponible.html)

---

### Ejercicio 7: AÃ±adiendo Anotaciones en Consultas
**URL:** `/productos/con-impuesto/`

Calcula un campo adicional `precio_con_impuesto` (19% IVA):

```python
Producto.objects.annotate(
    precio_con_impuesto=ExpressionWrapper(
        F('precio') * Value(Decimal('1.19')),
        output_field=DecimalField(max_digits=10, decimal_places=2)
    )
)
```

**Vista:** [`productos_con_impuesto`](individual5m7/productos/views.py)
**Template:** [`con_impuesto.html`](individual5m7/productos/templates/productos/con_impuesto.html)

---

### Ejercicio 8: Pasando ParÃ¡metros a raw()
**URL:** `/productos/raw-parametros/?precio_min=30`

Demuestra el uso seguro de parÃ¡metros para prevenir SQL injection:

```python
Producto.objects.raw(
    'SELECT * FROM productos_producto WHERE precio > %s',
    [precio_minimo]
)
```

**Vista:** [`productos_raw_parametros`](individual5m7/productos/views.py)
**Template:** [`raw_parametros.html`](individual5m7/productos/templates/productos/raw_parametros.html)

---

### Ejercicio 9: Ejecutando SQL Personalizado Directamente
**URL:** `/productos/insertar-sql/`

Usa `connection.cursor()` para ejecutar INSERT directo:

```python
with connection.cursor() as cursor:
    cursor.execute(
        "INSERT INTO productos_producto (nombre, precio, disponible) VALUES (%s, %s, %s)",
        [nombre, precio, disponible]
    )
```

**CuÃ¡ndo usar:**
- âœ… Operaciones masivas (bulk operations)
- âœ… Queries muy complejas
- âœ… Optimizaciones especÃ­ficas de MySQL
- âŒ NO para operaciones CRUD simples

**Vista:** [`insertar_producto_sql`](individual5m7/productos/views.py)
**Template:** [`insertar_sql.html`](individual5m7/productos/templates/productos/insertar_sql.html)

---

### Ejercicio 10: Conexiones y Cursores
**URL:** `/productos/cursor/`

Demuestra el uso de cursores para recuperar datos manualmente:

```python
with connection.cursor() as cursor:
    cursor.execute("SELECT id, nombre, precio, disponible FROM productos_producto")
    columns = [col[0] for col in cursor.description]
    for row in cursor.fetchall():
        productos_data.append(dict(zip(columns, row)))
```

**Ventajas:**
- Control total sobre la consulta
- Eficiente para grandes volÃºmenes
- CaracterÃ­sticas especÃ­ficas de MySQL

**Desventajas:**
- No usa el ORM
- Menos portable
- No retorna instancias del modelo

**Vista:** [`listar_con_cursor`](individual5m7/productos/views.py)
**Template:** [`cursor.html`](individual5m7/productos/templates/productos/cursor.html)

---

### Ejercicio 11: InvocaciÃ³n a Procedimientos Almacenados
**URL:** `/productos/procedimiento/?precio_min=50`

Invoca el procedimiento almacenado `obtener_productos_por_precio`:

```python
with connection.cursor() as cursor:
    cursor.callproc('obtener_productos_por_precio', [precio_minimo])
    for row in cursor.fetchall():
        productos_data.append({
            'id': row[0],
            'nombre': row[1],
            'precio': row[2],
            'disponible': row[3]
        })
```

**Vista:** [`productos_procedimiento`](individual5m7/productos/views.py)
**Template:** [`procedimiento.html`](individual5m7/productos/templates/productos/procedimiento.html)

---

## ğŸ¨ Interfaz de Usuario

Todas las vistas utilizan **Bootstrap 5.3.2** para un diseÃ±o responsivo y profesional.

### NavegaciÃ³n

La barra de navegaciÃ³n ([`base.html`](individual5m7/productos/templates/productos/base.html)) incluye enlaces a:

- Listar (Ejercicio 1)
- Filtrados (Ejercicio 2)
- Raw SQL (Ejercicio 3)
- Con Impuesto (Ejercicio 7)
- Cursor (Ejercicio 10)
- Procedimiento (Ejercicio 11)
- Admin Panel

### CaracterÃ­sticas del Frontend

- âœ… DiseÃ±o responsivo (mÃ³vil y escritorio)
- âœ… Tablas con striped rows y hover effects
- âœ… Badges para estados (Disponible/No disponible)
- âœ… Alertas informativas con cÃ³digo de ejemplo
- âœ… Formularios estilizados
- âœ… Colores diferenciados por ejercicio

---

## ğŸ”‘ Panel de AdministraciÃ³n

Accede al panel admin en: `http://127.0.0.1:8000/admin/`

**Funcionalidades:**
- âœ… Listar todos los productos
- âœ… Filtrar por disponibilidad
- âœ… Buscar por nombre
- âœ… Crear, editar y eliminar productos

Configurado en [`admin.py`](individual5m7/productos/admin.py):

```python
@admin.register(Producto)
class ProductoAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'precio', 'disponible')
    list_filter = ('disponible',)
    search_fields = ('nombre',)
```

---

## ğŸ“ Modelo de Datos

### Producto

Definido en [`models.py`](individual5m7/productos/models.py):

| Campo | Tipo | CaracterÃ­sticas |
|-------|------|----------------|
| `id` | BigAutoField | Clave primaria (auto-generada) |
| `nombre` | CharField(100) | Nombre del producto |
| `precio` | DecimalField(5,2) | Precio con 2 decimales |
| `disponible` | BooleanField | Estado de disponibilidad (default: True) |

**Ãndices:**
- `idx_nombre` en el campo `nombre` para optimizar bÃºsquedas

**Meta:**
```python
class Meta:
    db_table = 'productos_producto'
    indexes = [
        models.Index(fields=['nombre'], name='idx_nombre'),
    ]
```

---

## ğŸ§ª Comandos Ãštiles

### Django

```bash
# Crear migraciones
python manage.py makemigrations

# Aplicar migraciones
python manage.py migrate

# Shell interactivo
python manage.py shell

# Ver SQL de migraciones
python manage.py sqlmigrate productos 0001

# Verificar problemas
python manage.py check
```

### MySQL

```bash
# Conectar a MySQL
mysql -u root -p

# Usar la base de datos
USE individual5m7_db;

# Ver tablas
SHOW TABLES;

# Ver estructura de tabla
DESCRIBE productos_producto;

# Ver Ã­ndices
SHOW INDEX FROM productos_producto;

# Ver procedimientos
SHOW PROCEDURE STATUS WHERE Db = 'individual5m7_db';

# Ver cÃ³digo del procedimiento
SHOW CREATE PROCEDURE obtener_productos_por_precio;
```

---

## ğŸ“Š Conceptos Clave Aprendidos

### ORM vs SQL Directo

| Aspecto | ORM | SQL Directo |
|---------|-----|-------------|
| **Facilidad** | âœ… Alto nivel, pythÃ³nico | âš ï¸ Requiere conocer SQL |
| **Portabilidad** | âœ… Entre diferentes DBMS | âŒ EspecÃ­fico de MySQL |
| **Rendimiento** | âš ï¸ Puede ser menos eficiente | âœ… Control total |
| **Seguridad** | âœ… ProtecciÃ³n automÃ¡tica | âš ï¸ Requiere cuidado (SQL injection) |
| **Mantenibilidad** | âœ… FÃ¡cil de mantener | âš ï¸ MÃ¡s difÃ­cil |

### CuÃ¡ndo usar cada tÃ©cnica

**ORM (`objects.filter()`, `objects.all()`):**
- âœ… Operaciones CRUD estÃ¡ndar
- âœ… Filtros simples y medianos
- âœ… Relaciones entre modelos
- âœ… Desarrollo rÃ¡pido

**raw():**
- âœ… Queries complejas que el ORM no soporta bien
- âœ… AÃºn necesitas objetos del modelo
- âœ… Optimizaciones especÃ­ficas

**Cursores (`connection.cursor()`):**
- âœ… Operaciones masivas
- âœ… Queries extremadamente complejas
- âœ… Procedimientos almacenados
- âœ… No necesitas objetos del modelo

---

## ğŸ”’ Seguridad

### PrevenciÃ³n de SQL Injection

âŒ **NUNCA hagas esto:**
```python
# VULNERABLE
precio = request.GET.get('precio')
query = f"SELECT * FROM productos WHERE precio > {precio}"
```

âœ… **SIEMPRE usa parÃ¡metros:**
```python
# SEGURO
precio = request.GET.get('precio')
productos = Producto.objects.raw(
    'SELECT * FROM productos_producto WHERE precio > %s',
    [precio]
)
```

---

## ğŸ› Troubleshooting

### Error: ModuleNotFoundError: No module named 'productos'

**SoluciÃ³n:** AsegÃºrate de que la carpeta `productos` estÃ© dentro de `individual5m7/`

### Error: Access denied for user 'root'@'localhost'

**SoluciÃ³n:** Verifica las credenciales en [`settings.py`](individual5m7/individual5m7/settings.py)

### Error: (2003) Can't connect to MySQL server

**SoluciÃ³n:** 
1. Verifica que MySQL estÃ© corriendo
2. Comprueba el puerto (3306)
3. Revisa el firewall

### Error: PROCEDURE obtener_productos_por_precio does not exist

**SoluciÃ³n:** Ejecuta el script SQL para crear el procedimiento almacenado

---

## ğŸ“¦ Dependencias

```txt
Django==5.2.7
mysqlclient==2.2.4
```

---

## ğŸ‘¨â€ğŸ’» Autor

Proyecto desarrollado como parte del **MÃ³dulo 7** del curso de **Python** en **Talento Digital**.

---

## ğŸ“„ Licencia

Este proyecto es de uso educativo.

---

## ğŸ”„ Historial de Commits

```bash
git log --oneline
```

Commits sugeridos durante el desarrollo:

1. `Ejercicio 1: Modelo Producto creado`
2. `Ejercicios 2-8: Vistas con filtros, raw queries, anotaciones`
3. `Ejercicios 9-10: SQL directo con cursores`
4. `Ejercicio 11: Procedimientos almacenados`
5. `ConfiguraciÃ³n de URLs y admin`
6. `Templates Bootstrap completos`
7. `README actualizado con documentaciÃ³n completa`